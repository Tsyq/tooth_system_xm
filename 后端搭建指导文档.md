# 牙科预约管理系统 - 后端搭建指导文档

> 📚 本文档面向新手开发者，提供详细的后端环境搭建步骤，让您能够快速启动项目。

---

## 📋 目录

1. [环境要求](#1-环境要求)
2. [准备工作](#2-准备工作)
3. [安装步骤](#3-安装步骤)
4. [配置说明](#4-配置说明)
5. [启动项目](#5-启动项目)
6. [常见问题](#6-常见问题)
7. [下一步](#7-下一步)

---

## 1. 环境要求

在开始之前，请确保您的电脑已安装以下软件：

### 必需软件

- **Python 3.10+** 
  - 下载地址：https://www.python.org/downloads/
  - 安装时勾选 "Add Python to PATH"
  - 验证安装：打开命令行输入 `python --version`

- **MySQL 8.0+**
  - 下载地址：https://dev.mysql.com/downloads/mysql/
  - 安装时记住设置的 root 密码
  - 验证安装：打开命令行输入 `mysql --version`

- **Git**（可选，用于版本控制）
  - 下载地址：https://git-scm.com/downloads

### 推荐工具

- **PyCharm** 或 **VS Code**（代码编辑器）
- **Navicat** 或 **MySQL Workbench**（数据库管理工具）

---

## 2. 准备工作

### 2.1 创建 MySQL 数据库

1. 打开 MySQL 命令行或 MySQL Workbench

2. 登录 MySQL（使用 root 用户）：
   ```sql
   mysql -u root -p
   ```
   输入您的 root 密码

3. 创建数据库：
   ```sql
   CREATE DATABASE tooth_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

4. 验证数据库创建成功：
   ```sql
   SHOW DATABASES;
   ```
   应该能看到 `tooth_system` 数据库

5. 退出 MySQL：
   ```sql
   exit;
   ```

### 2.2 获取项目代码

如果您使用 Git：
```bash
git clone <项目地址>
cd Django_restapi_JWT
```

或者直接解压项目压缩包到指定目录。

---

## 3. 安装步骤

### 3.1 创建 Python 虚拟环境

**为什么需要虚拟环境？**
虚拟环境可以隔离项目依赖，避免不同项目之间的包冲突。

**Windows 系统：**
```bash
# 在项目根目录下执行
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate
```

**Mac/Linux 系统：**
```bash
# 在项目根目录下执行
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

**验证虚拟环境激活成功：**
激活后，命令行前面会显示 `(venv)` 标识。

### 3.2 安装 Python 依赖包

在虚拟环境激活的状态下，执行：

```bash
# 升级 pip（推荐）
python -m pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

**如果安装 mysqlclient 失败（Windows 常见问题）：**

**方案1：使用预编译的 wheel 文件**
```bash
# 访问 https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysqlclient
# 下载对应 Python 版本的 mysqlclient wheel 文件
# 例如：mysqlclient-2.2.0-cp310-cp310-win_amd64.whl

# 然后安装
pip install mysqlclient-2.2.0-cp310-cp310-win_amd64.whl
```

**方案2：使用 PyMySQL（临时替代方案）**
```bash
pip install PyMySQL
```

然后在 `tooth_system/__init__.py` 文件中添加：
```python
import pymysql
pymysql.install_as_MySQLdb()
```

**验证安装成功：**
```bash
pip list
```
应该能看到所有依赖包，包括 Django、djangorestframework 等。

### 3.3 配置环境变量

1. **复制环境变量示例文件：**
   ```bash
   # Windows
   copy .env.example .env
   
   # Mac/Linux
   cp .env.example .env
   ```

2. **编辑 .env 文件：**
   使用文本编辑器打开 `.env` 文件，根据实际情况修改以下配置：

   ```env
   # Django 密钥（生产环境必须修改！）
   SECRET_KEY=django-insecure-8^9bnj&3)2an&iqs^lt*up-1^c+qhpknmjiwlt@m9$^i-a=sl!
   
   # 调试模式
   DEBUG=True
   
   # 允许的主机
   ALLOWED_HOSTS=localhost,127.0.0.1
   
   # 数据库配置
   DB_NAME=tooth_system
   DB_USER=root
   DB_PASSWORD=你的MySQL密码
   DB_HOST=localhost
   DB_PORT=3306
   
   # CORS 跨域配置（前端地址）
   CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
   ```

   **重要提示：**
   - `DB_PASSWORD` 必须填写您安装 MySQL 时设置的 root 密码
   - `SECRET_KEY` 在生产环境必须修改（可以使用 Django 命令生成：`python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"`）

---

## 4. 配置说明

### 4.1 数据库配置

项目使用 MySQL 数据库，配置信息在 `.env` 文件中：

- `DB_NAME`: 数据库名称（默认：tooth_system）
- `DB_USER`: 数据库用户名（默认：root）
- `DB_PASSWORD`: 数据库密码（**必须修改为您的密码**）
- `DB_HOST`: 数据库主机（默认：localhost）
- `DB_PORT`: 数据库端口（默认：3306）

### 4.2 CORS 跨域配置

如果前端运行在不同的端口，需要在 `.env` 文件中添加前端地址：

```env
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

### 4.3 其他配置

- `DEBUG`: 开发环境设为 `True`，生产环境必须设为 `False`
- `ALLOWED_HOSTS`: 允许访问的主机地址，多个用逗号分隔

---

## 5. 启动项目

### 5.1 运行数据库迁移

**什么是数据库迁移？**
数据库迁移是将 Django 模型（models）转换为数据库表结构的过程。

```bash
# 生成迁移文件
python manage.py makemigrations

# 执行迁移（创建数据库表）
python manage.py migrate
```

**如果出现错误：**
- 检查 `.env` 文件中的数据库配置是否正确
- 确认 MySQL 服务已启动
- 确认数据库 `tooth_system` 已创建

### 5.2 创建超级管理员

```bash
python manage.py createsuperuser
```

按提示输入：
- 手机号（作为用户名）
- 姓名
- 密码（输入时不会显示，直接输入即可）
- 确认密码

**示例：**
```
手机号: 13800138000
姓名: admin
密码: ********
确认密码: ********
```

### 5.3 启动开发服务器

```bash
python manage.py runserver
```

**成功启动后，您会看到：**
```
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

### 5.4 访问项目

- **Django 管理后台：** http://127.0.0.1:8000/admin/
  - 使用刚才创建的超级管理员账号登录

- **API 接口文档：** http://127.0.0.1:8000/api/
  - 查看所有可用的 API 接口

---

## 6. 常见问题

### 6.1 数据库连接失败

**错误信息：**
```
django.db.utils.OperationalError: (2003, "Can't connect to MySQL server")
```

**解决方法：**
1. 检查 MySQL 服务是否启动
   - Windows: 打开"服务"，找到 MySQL，确保状态为"正在运行"
   - Mac: `brew services list` 查看 MySQL 状态
   - Linux: `sudo systemctl status mysql`

2. 检查 `.env` 文件中的数据库配置是否正确
   - 确认 `DB_PASSWORD` 是否正确
   - 确认 `DB_HOST` 和 `DB_PORT` 是否正确

3. 测试数据库连接：
   ```bash
   mysql -u root -p -h localhost
   ```

### 6.2 mysqlclient 安装失败

**Windows 系统常见问题**

**解决方法1：安装 Visual C++ 编译工具**
- 下载并安装：https://visualstudio.microsoft.com/visual-cpp-build-tools/
- 选择 "C++ 生成工具" 工作负载
- 重新执行 `pip install mysqlclient`

**解决方法2：使用 PyMySQL（推荐新手）**
```bash
pip install PyMySQL
```

在 `tooth_system/__init__.py` 中添加：
```python
import pymysql
pymysql.install_as_MySQLdb()
```

### 6.3 端口被占用

**错误信息：**
```
Error: That port is already in use.
```

**解决方法：**
1. 使用其他端口：
   ```bash
   python manage.py runserver 8001
   ```

2. 或者关闭占用 8000 端口的程序：
   ```bash
   # Windows
   netstat -ano | findstr :8000
   taskkill /PID <进程ID> /F
   
   # Mac/Linux
   lsof -ti:8000 | xargs kill -9
   ```

### 6.4 迁移文件冲突

**错误信息：**
```
django.db.migrations.exceptions.InconsistentMigrationHistory
```

**解决方法：**
```bash
# 删除所有迁移文件（除了 __init__.py）
# 然后重新生成
python manage.py makemigrations
python manage.py migrate
```

### 6.5 虚拟环境激活失败

**Windows PowerShell 报错：**
```
无法加载文件，因为在此系统上禁止运行脚本
```

**解决方法：**
以管理员身份运行 PowerShell，执行：
```powershell
Set-ExecutionPolicy RemoteSigned
```

---

## 7. 下一步

### 7.1 测试 API 接口

推荐使用 **Postman** 或 **Apifox** 测试 API：

1. 下载 Postman：https://www.postman.com/downloads/

2. 导入 API 文档（如果有）

3. 测试登录接口：
   - URL: `http://127.0.0.1:8000/api/auth/login/`
   - Method: POST
   - Body:
     ```json
     {
       "phone": "13800138000",
       "password": "your_password"
     }
     ```

### 7.2 查看项目结构

```
Django_restapi_JWT/
├── manage.py                 # Django 管理脚本
├── requirements.txt         # 依赖包列表
├── .env                     # 环境变量配置（不提交到Git）
├── .env.example             # 环境变量示例文件
├── tooth_system/            # 项目主配置目录
│   ├── settings.py         # 项目设置
│   ├── urls.py             # 主URL配置
│   └── wsgi.py             # WSGI配置
├── user/                    # 用户认证应用
├── hospitals/               # 医院管理应用
├── doctors/                 # 医生管理应用
├── appointments/            # 预约管理应用
├── records/                 # 病历管理应用
├── consultations/           # 在线问诊应用
├── ai_inquiry/             # AI问询应用
├── uploads/                 # 文件上传应用
├── statistics/              # 统计数据应用
└── utils/                   # 工具模块
```

### 7.3 开发建议

1. **熟悉 Django 基础**
   - Django 官方文档：https://docs.djangoproject.com/
   - Django REST Framework 文档：https://www.django-rest-framework.org/

2. **代码规范**
   - 遵循 PEP 8 Python 代码规范
   - 使用有意义的变量名和函数名
   - 添加必要的注释

3. **版本控制**
   - 使用 Git 进行版本控制
   - 提交前检查代码
   - 编写清晰的提交信息

4. **测试**
   - 编写单元测试
   - 测试 API 接口
   - 测试边界情况

---

## 📞 获取帮助

如果遇到问题：

1. **查看错误日志**
   - 检查命令行输出的错误信息
   - 查看 Django 日志文件

2. **查阅文档**
   - Django 官方文档
   - Django REST Framework 文档
   - 项目 README.md

3. **搜索解决方案**
   - Google 搜索错误信息
   - Stack Overflow
   - Django 社区论坛

---

## ✅ 检查清单

在开始开发前，请确认：

- [ ] Python 3.10+ 已安装
- [ ] MySQL 8.0+ 已安装并运行
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖包已安装
- [ ] `.env` 文件已配置
- [ ] 数据库已创建
- [ ] 数据库迁移已执行
- [ ] 超级管理员已创建
- [ ] 开发服务器已启动
- [ ] 可以访问管理后台

---

**祝您开发顺利！** 🎉

如有问题，请参考本文档的"常见问题"部分，或查阅相关文档。

